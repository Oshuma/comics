#!/usr/bin/env bash

case "$RAILS_ENV" in
production)
	container="comics"
	database="comics"
	network="comics"
	storage="comics"
	;;
*)
	container="comics_development"
	database="comics_development"
	network="comics_development"
	storage="comics_development"
	;;
esac

db_host="postgres"
image="comics:latest"
master_key=$(cat config/master.key)

database_url="postgres://postgres:postgres@$db_host:5432/$database"

echo "== Starting container"
docker run \
	-it \
	--rm \
	--detach \
	--name $container \
	-p 3000:3000 \
	-e RAILS_ENV=$RAILS_ENV \
	-e DATABASE_URL=$database_url \
	-e RAILS_MASTER_KEY=$master_key \
	-v $storage:/app/storage \
	$image

echo "== Setting up network"
docker network create $network 2>/dev/null
docker network connect $network $container 2>/dev/null
docker network connect $network $db_host 2>/dev/null

echo "== Running migrations"
docker exec -it $container sh -c "bin/rails db:create && bin/rails db:migrate"

docker logs $container # Dump any logs printed before attaching.
docker attach $container
